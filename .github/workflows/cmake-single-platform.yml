name: Flutter CI

on:
  push:
    branches:
      - development
      - master
  pull_request:
    branches:
      - development
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.1'

      - name: Flutter pub get
        run: flutter pub get

      - name: Flutter analyze (no fail)
        run: flutter analyze || true

      - name: Flutter test (no fail)
        run: flutter test || true

      - name: Build APK
        run: flutter build apk --release

      ##############################
      # 1️⃣ SUBIR A DIAWI
      ##############################
      - name: Upload APK to Diawi
        id: diawi_upload
        run: |
          echo "Subiendo a Diawi..."

          RESPONSE=$(curl -s -X POST "https://upload.diawi.com/" \
            -H "accept: application/json" \
            -F "token=${{ secrets.DIAWI_TOKEN }}" \
            -F "file=@build/app/outputs/flutter-apk/app-release.apk")

          echo "$RESPONSE" > diawi_response.json
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          # Validar JSON
          if ! echo "$RESPONSE" | jq . >/dev/null 2>&1; then
            echo "ERROR: Diawi NO respondió JSON:"
            cat diawi_response.json
            exit 1
          fi

          JOB_ID=$(echo "$RESPONSE" | jq -r '.job')
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV

      - name: Save Diawi Response as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: diawi-upload-response
          path: diawi_response.json

      ##############################
      # 2️⃣ POLLING HASTA OBTENER LINK
      ##############################
      - name: Poll Diawi until link is ready
        id: diawi_poll
        run: |
          echo "Esperando link final..."
          for i in {1..20}
          do
            STATUS=$(curl -s -X POST "https://upload.diawi.com/status" \
              -F "token=${{ secrets.DIAWI_TOKEN }}" \
              -F "job=${{ env.JOB_ID }}")

            echo "STATUS: $STATUS"

            if echo "$STATUS" | jq . >/dev/null 2>&1; then
              LINK=$(echo "$STATUS" | jq -r '.link')

              if [ "$LINK" != "null" ]; then
                echo "DIAWI_LINK=$LINK" >> $GITHUB_ENV
                echo "link=$LINK" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            echo "No listo aún. Intento $i/20"
            sleep 10
          done

          echo "ERROR: Diawi nunca devolvió link"
          exit 1

      ##############################
      # 3️⃣ LEER VERSION + BUILD
      ##############################
      - name: Read version from pubspec.yaml
        id: version_reader
        run: |
          VERSION_LINE=$(grep '^version:' pubspec.yaml)
          VERSION=$(echo $VERSION_LINE | cut -d ' ' -f2 | cut -d '+' -f1)
          BUILD=$(echo $VERSION_LINE | cut -d '+' -f2)

          echo "APK_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APK_BUILD=$BUILD" >> $GITHUB_ENV

      ##############################
      # 4️⃣ GUARDAR EN TU API
      ##############################
      - name: Save metadata to API
        run: |
          curl -X POST "${{ secrets.API_URL }}/versions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_KEY }}" \
            -d "{
              \"version\": \"${{ env.APK_VERSION }}\",
              \"build\": \"${{ env.APK_BUILD }}\",
              \"diawi_link\": \"${{ steps.diawi_poll.outputs.link }}\"
            }"



