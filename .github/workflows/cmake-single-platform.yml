name: Flutter CI

on:
  push:
    branches: [development, master]
  pull_request:
    branches: [development, master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.1'

      - name: Flutter pub get
        run: flutter pub get

      - name: Flutter analyze (no fail)
        run: flutter analyze || true

      - name: Flutter test (no fail)
        run: flutter test || true

      - name: Build APK
        run: flutter build apk --release

      ############################################################
      # 1️⃣ SUBIR APK A DIAWI
      ############################################################
      - name: Upload APK to Diawi
        id: diawi_upload
        run: |
          echo "Subiendo APK a Diawi..."

          RESPONSE=$(curl -s -X POST "https://upload.diawi.com/" \
            -H "accept: application/json" \
            -F "token=${{ secrets.DIAWI_TOKEN }}" \
            -F "file=@build/app/outputs/flutter-apk/app-release.apk")

          echo "$RESPONSE" > diawi_response.json

          # Validar JSON
          if ! echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            echo "ERROR: Diawi NO devolvió JSON válido:"
            cat diawi_response.json
            exit 1
          fi

          JOB_ID=$(echo "$RESPONSE" | jq -r '.job')
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
          echo "job=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Save Diawi response as artifact
        uses: actions/upload-artifact@v4
        with:
          name: diawi-upload-response
          path: diawi_response.json

      ############################################################
      # 2️⃣ ESPERAR A QUE DIAWI GENERE EL LINK FINAL (CORREGIDO)
      ############################################################
      - name: Poll Diawi until link ready
        id: diawi_poll
        run: |
          echo "Esperando link final..."

          for i in {1..20}
          do
            RESULT=$(curl -s "https://upload.diawi.com/status?token=${{ secrets.DIAWI_TOKEN }}&job=${{ env.JOB_ID }}")
            echo "STATUS: $RESULT"

            # Validar JSON
            if ! echo "$RESULT" | jq -e . >/dev/null 2>&1; then
              echo "⚠️ Diawi devolvió algo NO JSON:"
              echo "$RESULT"
              echo "Reintentando..."
              sleep 10
              continue
            fi

            LINK=$(echo "$RESULT" | jq -r '.link // empty')

            if [ ! -z "$LINK" ]; then
              echo "DIAWI_LINK=$LINK" >> $GITHUB_ENV
              echo "link=$LINK" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Aún no está listo. Intento $i/20"
            sleep 10
          d
